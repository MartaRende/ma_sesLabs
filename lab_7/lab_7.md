# Lab 7

## Questions

### ICMP Log

To activate logging and dropping of the ICMP packets, you can use those commands : 
```bash
# This is to log ICMP packets
iptables -A INPUT -p icmp -j LOG --log-prefix "ICMP-DROP: " --log-level 4
# This is to drop the packets
iptables -D OUTPUT -d 192.168.1.90 -j DROP
```

To activate reject of the ICMP packet : 
```bash
# First, remove the drop rule
iptables -D INPUT -p icmp -j DROP
# Then add the reject rule. You need to add an error message
iptables -A INPUT -p icmp -j REJECT --reject-with icmp-port-unreachable
```


### SSH connection only
To allow only ssh connection from the PC on the nano : 
```bash
# First flush all current rules
iptables -F
iptables -X

# Flush existing rules
iptables -F

# Allow incoming SSH from PC
iptables -A INPUT -p tcp -s 192.168.0.1 --dport 22 -j ACCEPT

# Allow local loopback traffic
iptables -A INPUT -i lo -j ACCEPT
iptables -A OUTPUT -o lo -j ACCEPT

# Allow NanoPI to send responses to the PC on SSH (return traffic)
iptables -A OUTPUT -p tcp -d 192.168.0.1 --sport 22 -j ACCEPT

# Drop everything else
iptables -A INPUT -j DROP
iptables -A FORWARD -j DROP
iptables -A OUTPUT -j DROP
```


## What does those rules do ?

```bash
# This rule is triggered when a packet arrives on the loopback interface (lo)
iptables –A INPUT -i lo –j ACCEPT // Local traffics are allowed between applications

# Those are the default rules
iptables –P INPUT DROP

iptables –P OUTPUT ACCEPT

iptables –P FORWARD DROP

iptables -N dynamic

iptables -N net2fw // New chain: Network to Firewall

# If the packet comes to interface eth0 -> it is redirected to the chain net2fw
iptables -A INPUT -i eth0 -j net2fw

# If this is a new connection, it is diverted to the dynamic chain, before coming back to finish the net2fw chain
iptables -A net2fw -m conntrack --ctstate NEW -j dynamic

# This rules is skipped as this is  anew connection
iptables -A net2fw -m conntrack --ctstate RELATED,ESTABLISHED -j ACCEPT

# The packet match this rule -> it is accepted
iptables -A net2fw -p tcp -m tcp --dport 62200 -j ACCEPT

# This rule is not activated
iptables -A net2fw -j LOG --log-prefix "net2fw:DROP:" --log-level 6

iptables -A net2fw -j DROP 
```

```bash
# Clear existing rules (a common starting point for scripts)
iptables -F
iptables -X

# Set Default Policies (DROP is safer than ACCEPT)
iptables -P INPUT DROP
iptables -P OUTPUT ACCEPT
iptables -P FORWARD DROP

# 1. Allow Loopback Traffic (Essential for local apps)
iptables -A INPUT -i lo -j ACCEPT

# 2. Allow RELATED and ESTABLISHED connections (the most important security rule)
# This rule is placed directly in the INPUT chain for maximum efficiency.
iptables -A INPUT -m conntrack --ctstate RELATED,ESTABLISHED -j ACCEPT

# 3. Allow Specific NEW Services

# Allow SSH (Port 22 is a common example)
# iptables -A INPUT -p tcp -m tcp --dport 22 -m conntrack --ctstate NEW -j ACCEPT

# Allow the target Service (Port 62200)
iptables -A INPUT -p tcp -m tcp --dport 62200 -m conntrack --ctstate NEW -j ACCEPT


# 4. Final DROP
# Log rejected connections before dropping them for analysis
iptables -A INPUT -j LOG --log-prefix "FINAL-DROP:" --log-level 6
iptables -A INPUT -j DROP
```

## What are the IPV4 Hooks ?

1. NF_INET_PRE_ROUTING
Purpose : Packet received from a network interface, before the routing decision is made.

1. NF_INET_LOCAL_IN
Purpose : Packet is destined for a local process.

1. NF_INET_FORWARD
Purpose : Packet is not for the local process and is being forwarded to another host (routing decision has been made).

1. NF_INET_LOCAL_OUT
Purpose : Packet is generated by a local process on the firewall/NanoPI, before the routing decision is made.

1. NF_INET_POST_ROUTING
Purpose : Packet is leaving the firewall/NanoPI via a network interface, after the final routing decision.

## nfq-icmp

To upload the program :
```bash
scp nfq-icmp marttave@192.168.0.14:/home/marttave/nfq-icmp
```

Then to create the queue and launch the program : 
```bash

iptables -A INPUT -p icmp -j NFQUEUE --queue-num 0
./nfq-icmp 
# pkt received
# hw_protocol=0x0800 hook=1 id=1 
#  entering callback
# pkt received
# hw_protocol=0x0800 hook=1 id=2 
#  entering callback
# pkt received
# hw_protocol=0x0800 hook=1 id=3 
#  entering callback
```

To drop the packages instead, you can replace the NF_ACCEPT by a NF_DROP, and then the sender of the ping would get no response (timeout)
